# ブルートゥースを使用したSSH接続の実験

ブルートゥースを使用してSSH接続をすることができるという面白い話をご存知ですか？冗談のつもりで試してみたところ、実際に接続が成功してしまいました。さらに、tmuxなどもほぼ問題なく使用することができます。手順は[こちら](https://nicosys.slack.com/archives/C1L815FHS/p1694756864911669?thread_ts=1694613633.984689&amp;***=C1L815FHS)で紹介されています。

通常、ブルートゥースにはポートは存在しないため、今回の実験ではRFCOMM（シリアル通信）にSSH（TCPパケット）を乗せることで実現しています。シリアルなのにSSH接続ができるというのは確かに非常に興奮することですし、予想外の成功でした。MacとLinux間のSSH接続にブルートゥースを使用するというのは魅力的な実験となりそうです。近い将来、この実験を行うためにMacを入手することを考えています。

話がそれますが、ブルートゥースで接続する場合、恐らくmacOSが一番難しさを感じると思います（*** 固有の挙動が多すぎて辛いです）。難易度順に言うと、macOS &gt;&gt;&gt; Windows (WSL) &gt; ***となります。ちなみに、iptablesにREJECTを設定してみたら問題なく接続できましたが、思いもよらぬループバックで詰まっていたようです。

M5StackのメンテナンスポートをRFCOMM/telnetにしているため、sshに変更したくなってきました。（ただし、PANは使用しない方針です）

それはさておき、普通のSSHと同じように接続できるため、Local port forwardingでHTTP/RDP転送やX11転送、SCPなども可能です。まさにカオスですね！

ブルートゥースでの接続は比較的簡単にできるようです。（RFCOMM / telnetが利用できる場合、少しの設定で可能です）ただし、M5Stackはオペレーティングシステムが載っていないため、必要なものはbluez、bluez-compat（sdptool、rfcomm）、sshd、socatです。（ただし、カーネル側にCONFIG_RFCOMMが設定されていることが前提です。ほとんどのディストリビューションは設定されているはずです）

M5StackはESP32と呼ばれるもので、FreeRTOSを使用しています。BLE/BTモジュールには自分でプログラムを書くことができるため、問題ありません。これはとても楽しそうですね！また、FreeRTOSにはsocatなども使用できそうですか？

M5Stackは開発環境が***と互換性がありますが、内部はESP32です。FreeRTOS自体に手を入れるのはあまりおすすめしませんが、ESP32のAPIだけで様々なBluetoothプロファイルを書くことができます。（オリジナルのプロファイルを作成することもできます）最近のESP32には有名なプロファイルの実装も提供されているため、実装の楽しみが減ってしまったかもしれません。

C言語で低レベルな操作ができるのは最大の楽しみですね。（購入しようかな...考え中ですが、他にも[こちら](https://www.espruino.com)も欲しいです）

Espruinoですね（笑）（手を出したら沼にハマると思っている人は、みんな同じですね。Raspberry Pi***も気になります。もちろん、ファームウェアを書き換える前提ですが（***はどこかに転がっているはず...）以下の手順でssh接続できるようになります。要はsocatでRFCOMM ⇔ TCPの中継をしているだけです。

SSH Server:
```
sdptool add --channel=3 SP
rfcomm -r watch 0 3 socat /dev/rfcomm0 tcp:localhost:22
```

SSH Client (macOS):
```
ssh -oProxyCommand='socat /dev/tty.YOUR_BT_DEVICE_NAME -' -oUser=username
```

※*** ⇔ ***, *** ⇔ Windows(WSL)の場合は別途、rfcomm bindが必要です。

さらに、ブルートゥースによるHTTP over RFCOMM（SSHダイナミックポートフォワーディング）も可能です。WiFiやLANケーブルを使用せずにインターネット接続することができます。意外と普通にネットが使えて、感動しました。ただし、上りは少々辛いですね...